#!/bin/bash

if [ -z "$1" ]
then
	echo "Usage: $0: <nasm file>"
	echo "nasm file should have a .nasm extension but don't include it in the argument name"
	echo "nasm file should be in the same directory"
	exit
fi

echo "Creating .o file from:	 	$1.nasm"
nasm -f elf32 -o $1_o.o $1.nasm

echo "Linking to create:		$1_assembly"
ld -melf_i386 -o $1_assembly $1_o.o

echo "Extracting shellcode to: 		$1_shellcode"
./sc_extract.sh $1_assembly > $1_shellcode

echo "Creating sc test skeleton: 	$1_c.c"
cp sc_tester.c $1_c.c

echo "Putting shellcode in: 		$1_c.c"
sed -i 's/\\/\\\\/g' $1_shellcode
sed -i "s/<shellcode_here>/$(cat $1_shellcode);/" $1_c.c
sed -i 's/\\\\/\\/g' $1_shellcode

echo "Compiling c code to: 		$1_elf"
gcc -m32 -z execstack -fno-stack-protector -w -o $1_elf $1_c.c
